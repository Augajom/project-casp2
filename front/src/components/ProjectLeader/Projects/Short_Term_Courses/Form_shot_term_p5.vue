<template>
  <div>
      <NavbarProject class="fixed-top " propText="‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)" />
        <ProgressBar class="fixed-top border" :step="currentStep" @update:step="currentStep" />
        <Loader  v-if="loading"/>
        <div class="container-fluid" style="min-height: 1300px; margin-top: 250px">
        <div class="d-flex justify-content-center">
          <div
            class="container d-flex flex-column border px-5 shadow p-3 mb-5"
            style="
              max-width: 1200px;
              min-width: 1200px;
              background-color: #374375;
              border-radius: 12px;
              height: auto;
            "
          >
            <div class="row text-white fs-3 mt-3">
              <p>‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</p>
            </div>
            <div class="p-2">
              <div class="row">
                <label class="text-white" for="location">
                  <span class="fs-5 fw-light"
                    ><b
                      >‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡∏ß‡∏±‡∏î (Assessment) ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ ‡πÅ‡∏•‡∏∞/‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÉ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</b
                    ></span
                  >
                </label>
                <div class="container mt-1 p-3">
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.assessmentMethods.prePostTest.checked"
                        type="checkbox"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡πà‡∏≠‡∏ô-‡∏´‡∏•‡∏±‡∏á ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                      </label>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.assessmentMethods.projectEvaluation.checked"
                        type="checkbox"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô/‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
                      </label>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.assessmentMethods.observation.checked"
                        type="checkbox"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå/‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°
                      </label>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.assessmentMethods.others.checked"
                        type="checkbox"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
                      </label>
                    </div>
                  </div>
                  <input
                    type="text "
                    v-if="Project_Data_ST_P5.assessmentMethods.others.checked"
                    v-model="Project_Data_ST_P5.assessmentMethods.others.value"
                    class="form-control mt-3 beautiful-box"
                    placeholder="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
                  />
                </div>
              </div>

              <div class="row mt-1">
                <label class="text-white" for="location">
                  <span class="fs-5 fw-light"><b>‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</b></span>
                </label>
                <div class="container mt-1 p-3">
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.followUpMethods.followUpObservation.checked"
                        type="checkbox"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå/‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°)
                      </label>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.followUpMethods.followUpPerformance.checked"
                        type="checkbox"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
                      </label>
                    </div>
                  </div>

                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.followUpMethods.otherDetails.checked"
                        type="checkbox"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
                      </label>
                    </div>
                  </div>
                  <input
                    type="text "
                    v-if="Project_Data_ST_P5.followUpMethods.otherDetails.checked"
                    v-model="Project_Data_ST_P5.followUpMethods.otherDetails.value"
                    class="form-control mt-3 beautiful-box"
                    placeholder="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
                  />
                </div>
              </div>
              <div class="mb-3 mt-3">
                <label class="fs-5 fw-light text-white" for="project_duration"
                  ><b>‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</b></label
                >
                <div class="row mt-3">
                  <div class="col-6">
                    <div class="d-flex flex-column">
                      <div>
                        <div class="text-center">
                          <label class="text-white" for="start_date">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        </div>
                        <div class="mt-2">
                          <input
                            type="date"
                            v-model="Project_Data_ST_P5.followUpDuration.startDate"
                            class="form-control text-center fw-light text-muted beautiful-box"
                            name=""
                            id=""
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="d-flex flex-column">
                      <div>
                        <div class="text-center">
                          <label class="text-white" for="end_date">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        </div>
                        <div class="d-flex mt-2">
                          <input
                            type="date"
                            v-model="Project_Data_ST_P5.followUpDuration.endDate"
                            class="form-control text-center fw-light text-muted beautiful-box"
                            name=""
                            id=""
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <label class="text-white" for="location">
                  <span class="fs-5 fw-light"
                    ><b>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£</b></span
                  >
                </label>
                <div class="container mt-1 p-3">
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.projectImpact.description"
                        type="radio"
                        name="target"
                        value="report"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£
                      </label>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.projectImpact.description"
                        type="radio"
                        name="target"
                        value="committee"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡∏Ñ‡∏ì‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏≠‡∏á (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏ô‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
                      </label>
                    </div>
                    <div
                      class="mt-2"
                      v-if="Project_Data_ST_P5.projectImpact.description === 'committee'"
                    >
                      <div>
                        <p class="text-warning" style="margin: 0.7rem 0 0 5.5rem;">
                          ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå Word (.doc, .docx), PDF (.pdf), Excel (.xls, .xlsx) ‡πÅ‡∏•‡∏∞ ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 MB.
                        </p>
                        <div class="d-flex">
                          <div class="relative inline-block">
                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡∏ô input -->
                            <label
                              for="file-upload"
                              class="btn btn-sm btn-light"
                              style="left: 90px; position: relative; margin-top: 0.5rem;"
                            >
                              ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå
                            </label>

                            <!-- input file ‡∏ã‡πà‡∏≠‡∏ô -->
                            <input
                              id="file-upload"
                              type="file"
                              class="d-none"
                              @change="handleFileChange"
                            />
                          </div>
                          <p class="text-white" style="margin: 0.7rem 0 0 6rem; width: 55rem;">
                            <span v-if="fileName">{{ fileName }}</span>
                            <span v-else>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                          </p>
                        </div>

                        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
                        <div v-if="existingFileName">
                          <p class="text-white"
                          style="left: 90px; position: relative; margin-top: 1rem; width: 60rem;">

                            ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏° :
                            <a
                              class="btn btn-sm btn-secondary"
                              :href="`http://localhost:5000/Files/${existingFileName}`"
                              :download="existingFileName" target="_blank"
                              >{{existingFileName.split('-').slice(5).join('-')}}</a
                            >
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row mb-2">
                    <div class="col-1 d-flex justify-content-center">
                      <input
                        class="form-check-input circle-input"
                        v-model="Project_Data_ST_P5.projectImpact.description"
                        type="radio"
                        name="target"
                        value="externalData"
                      />
                    </div>
                    <div class="col-11">
                      <label class="form-check-label text-white" for="flexCheckDefault">
                        ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏ô‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
                      </label>
                    </div>
                    <div
                      class="mt-2"
                      v-if="Project_Data_ST_P5.projectImpact.description === 'externalData'"
                    >
                      <div>
                        <p class="text-warning" style="margin: 0.7rem 0 0 5.5rem;">
                          ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå Word (.doc, .docx), PDF (.pdf), Excel (.xls, .xlsx) ‡πÅ‡∏•‡∏∞ ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 MB.
                        </p>
                        <div class="d-flex">
                          <div class="relative inline-block">
                            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡∏ô input -->
                            <label
                              for="file-upload"
                              class="btn btn-sm btn-light"
                              style="left: 90px; position: relative; margin-top: 0.5rem;"
                            >
                              ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå
                            </label>

                            <!-- input file ‡∏ã‡πà‡∏≠‡∏ô -->
                            <input
                              id="file-upload"
                              type="file"
                              class="d-none"
                              @change="handleFileChange"
                            />
                          </div>
                          <p class="text-white" style="margin: 0.7rem 0 0 6rem; width: 55rem;">
                            <span v-if="fileName">{{ fileName }}</span>
                            <span v-else>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                          </p>
                        </div>

                        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
                        <div v-if="existingFileName">
                          <p class="text-white"
                          style="left: 90px; position: relative; margin-top: 1rem; width: 60rem;">

                            ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏° :
                            <a
                              class="btn btn-sm btn-secondary"
                              :href="`http://localhost:5000/Files/${existingFileName}`"
                              :download="existingFileName" target="_blank"
                              >{{existingFileName.split('-').slice(5).join('-')}}</a
                            >
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6 d-flex justify-content-end">
                <router-link
                  :to="{
                    path: '/pl/st/p_4',
                    query: { project_id: project_id || '', project_type: 3 },
                  }"
                >
                  <button
                    class="btn btn-secondary"
                    style="width: 140px"
                    @click="prevStep"
                    :disabled="currentStep === 1"
                  >
                    ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                  </button>
                </router-link>
              </div>
              
              <div class="col-6">
                <button
                  class="btn btn-success"
                  style="width: 140px"
                  @click="submitForm"
                  :disabled="!isCanGo"
                >  
                  <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
    
</template>

<script setup>
import axios from "axios";
import Loader from "@/components/Loader.vue";
import ProgressBar from "@/components/ProgressBar.vue";
import parseJwt from "../../../../../utils/DecodeToken";
import { ref, reactive, watch, onMounted, onUnmounted } from "vue";
import NavbarProject from "@/components/NavbarProject.vue";
import Swal from "sweetalert2";
import { useRoute, useRouter } from "vue-router";
import { useCookies } from "vue3-cookies";
const { cookies } = useCookies();
const router = useRouter();
const Toast = Swal.mixin({
  toast: true,
  position: "bottom-end",
  //   iconColor: 'black',
  customClass: {
    popup: "colored-toast",
  },
  showConfirmButton: false,
  timer: 3000,
  timerProgressBar: true,
  didOpen: (toast) => {
    toast.addEventListener("mouseenter", Swal.stopTimer);
    toast.addEventListener("mouseleave", Swal.resumeTimer);
  },
});

const currentStep = ref(5);

const project_id = ref(null);
const project_type = ref(null);
const user_id = ref(null);
const affiliation_id = ref(null);

let loading = ref(false)
let isInitialized = false;
let canEdit = false;
let isCanGo = ref(false);

const Project_Data_ST_P5 = reactive({
  assessmentMethods: {
    //must ckecked at least 1
    prePostTest: {
      checked: false,
      value: "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏Å‡πà‡∏≠‡∏ô-‡∏´‡∏•‡∏±‡∏á ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    },
    projectEvaluation: {
      checked: false,
      value: "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£",
    },
    observation: { checked: false, value: "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏ì‡πå/‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°" },
    others: { checked: false, value: "" }, // if ckecked is true ,value must not empty
  },
  followUpMethods: {
    //must ckecked at least 1
    followUpObservation: {
      checked: false,
      value: "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà (‡∏™‡∏±‡∏°‡∏†‡∏≤‡∏©‡∏ì‡πå/‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°)",
    },
    followUpPerformance: { checked: false, value: "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" },
    otherDetails: { checked: false, value: "" }, // if ckecked is true ,value must not empty
  },
  followUpDuration: {
    startDate: "", // mm/dd/yyyy //required
    endDate: "", // mm/dd/yyyy //required
  },
  projectImpact: {
    id: 1,
    file: null,
    description: "", // if description is "report" tis no need to have file, file cannot be null
  },
});

function debounce(func, delay) {
  let timer;
  return function (...args) {
    clearTimeout(timer);
    timer = setTimeout(() => {
      func.apply(this, args);
    }, delay);
  };
}

const getDataWhenProjectID = async () => {
  try {
    const response = await axios.post("http://localhost:5000/pl/ST/get/p_5", {
      project_id: project_id.value,
      project_type: project_type.value,
      project_user: user_id.value,
    });

    const project_data = JSON.parse(response.data.data[0].project_data_p_5);
    //console.log(project_data);
    Project_Data_ST_P5.assessmentMethods = project_data.assessmentMethods;
    Project_Data_ST_P5.followUpMethods = project_data.followUpMethods;
    Project_Data_ST_P5.followUpDuration = project_data.followUpDuration;
    Project_Data_ST_P5.projectImpact = project_data.projectImpact;

    // //console.log('sending a request to fetch editing data project id = ',project_id)
  } catch (err) {
    //console.log(err);
    //console.log("error fetching editing data = ", project_id.value);
  }
};

//Upload File
const files = ref([]);
const fileName = ref('')
const pageName = 'page5' // ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏¥‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÜ

const allowedTypes = [
  "application/pdf",
  "application/vnd.ms-excel",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  "application/msword",
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
];
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB

const handleFileChange = (event) => {
  const selectedFiles = Array.from(event.target.files);

  const validFiles = selectedFiles.filter(
    (file) => allowedTypes.includes(file.type) && file.size <= MAX_FILE_SIZE
  );

  if (validFiles.length !== selectedFiles.length) {
    Toast.fire({
      icon: "error",
      iconColor: "red",
      title: `‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF, Word, Excel ‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 MB. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`,
    });
  }

  files.value = validFiles;
  Project_Data_ST_P5.projectImpact.file = validFiles.length > 0 ? validFiles[0] : null; // ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö data ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Project_Data_P7

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  fileName.value = validFiles.length > 0 ? validFiles[0].name : '';
};

const submitFile = async () => {
  if (files.value.length === 0 && !existingFileName) {
    Toast.fire({
      icon: "error",
      iconColor: "red",
      title: `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô`,
    });
    return;
  }

  const formData = new FormData();
  formData.append("file", files.value[0]);

  const query = `?projectId=${project_id.value}&projectType=${project_type.value}&page=${pageName}`;

  try {
    const response = await axios.post(
      `http://localhost:5000/pl/upload/file${query}`,
      formData,
      {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      }
    );

    if (response.data.success) {
      //console.log("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", response.data);
      Project_Data_ST_P5.projectImpact.fileName = response.data.file.filename;
    } else {
      console.warn("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    }
  } catch (error) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‚úÖ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß", error);
  }
};

//Api Get File ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏õ
const existingFileName = ref(null);

const fetchExistingFile = async () => {
  try {
    const res = await axios.get(
      `http://localhost:5000/pl/file/display?projectId=${project_id.value}&projectType=${project_type.value}&page=${pageName}`
    );
    existingFileName.value = res.data.file;

    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡πÅ‡∏ô‡∏ö
    if (existingFileName.value) {
      Project_Data_ST_P5.projectImpact.file = { name: existingFileName.value };
    }
  } catch (err) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°:", err);
  }
};


const autoSave = debounce(async () => {
  try {
    const response = await axios.post("http://localhost:5000/pl/p_5/shot_term/save", {
      project_id: project_id.value,
      project_type: project_type.value,
      project_user: user_id.value,
      project_data: Project_Data_ST_P5,
      project_affiliation: affiliation_id.value,
    });
    //console.log(response.data);
    if (response.data.success) {
      project_id.value = response.data.insert_id;
      //console.log("project_id", project_id.value);
      router.replace({
        path: "/pl/st/p_6",
        query: { project_id: project_id.value || "", project_type: 3 },
      });
      await setTimeout(() => {
        loading.value = false;
      }, 500);
      Toast.fire({
        icon: "success",
        iconColor: "green",
        title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
      });
    } else {
      Toast.fire({
        icon: "error",
        iconColor: "red",
        title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`,
      });
    }
  } catch (error) {
    console.error(error);
    Toast.fire({
      icon: "error",
      iconColor: "red",
      title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`,
    });
  }
},  );

watch(
    Project_Data_ST_P5,
  (newVal, oldVal) => {
    //console.log("Project_Data_ST_P5 has changed:");
    if (isInitialized && !canEdit) {
      //console.log("return when fetching state");
      return 0;
    }
    // autoSave()
  },
  { deep: true }
);

watch(
  Project_Data_ST_P5,
  (newVal) => {
    //console.log("--- Checking Project_Data_P5 ---");

    // 1. ‡∏ï‡∏£‡∏ß‡∏à assessmentMethods: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà checked
    const assessment = Object.values(newVal.assessmentMethods);
    const isAssessmentChecked = assessment.some((method) => method.checked);
    if (!isAssessmentChecked) {
      //console.log("‚ùå No assessment method is checked");
      isCanGo.value = false;
      return;
    }
    //console.log("‚úÖ At least one assessment method is checked");

    // ‡∏ñ‡πâ‡∏≤ others ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å value ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
    if (
      newVal.assessmentMethods.others.checked &&
      !newVal.assessmentMethods.others.value?.trim()
    ) {
      //console.log("‚ùå assessmentMethods.others is checked but value is empty");
      isCanGo.value = false;
      return;
    }
    if (newVal.assessmentMethods.others.checked) {
      //console.log("‚úÖ assessmentMethods.others:", newVal.assessmentMethods.others.value);
    }

    // 2. ‡∏ï‡∏£‡∏ß‡∏à followUpMethods: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà checked
    const followUp = Object.values(newVal.followUpMethods);
    const isFollowUpChecked = followUp.some((method) => method.checked);
    if (!isFollowUpChecked) {
      //console.log("‚ùå No follow-up method is checked");
      isCanGo.value = false;
      return;
    }
    //console.log("‚úÖ At least one follow-up method is checked");

    // ‡∏ñ‡πâ‡∏≤ otherDetails ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å value ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
    if (
      newVal.followUpMethods.otherDetails.checked &&
      !newVal.followUpMethods.otherDetails.value?.trim()
    ) {
      //console.log("‚ùå followUpMethods.otherDetails is checked but value is empty");
      isCanGo.value = false;
      return;
    }
    // if (newVal.followUpMethods.otherDetails.checked) {
    //   //console.log(
    //     "‚úÖ followUpMethods.otherDetails:",
    //     newVal.followUpMethods.otherDetails.value
    //   );
    // }

    // 3. ‡∏ï‡∏£‡∏ß‡∏à followUpDuration
    if (!newVal.followUpDuration.startDate?.trim()) {
      //console.log("‚ùå followUpDuration.startDate is empty");
      isCanGo.value = false;
      return;
    }
    //console.log("‚úÖ followUpDuration.startDate:", newVal.followUpDuration.startDate);

    if (!newVal.followUpDuration.endDate?.trim()) {
      //console.log("‚ùå followUpDuration.endDate is empty");
      isCanGo.value = false;
      return;
    }
    //console.log("‚úÖ followUpDuration.endDate:", newVal.followUpDuration.endDate);

    if (newVal.followUpDuration.endDate?.trim() < newVal.followUpDuration.startDate?.trim()) {
      isCanGo.value = false;
      return;
    }

    if (newVal.followUpDuration.endDate?.trim() === newVal.followUpDuration.startDate?.trim()) {
      isCanGo.value = false;
      return;
    }

    // 4. ‡∏ï‡∏£‡∏ß‡∏à projectImpact
    const impact = newVal.projectImpact;
    if (!impact.description?.trim()) {
      //console.log("‚ùå projectImpact.description is empty");
      isCanGo.value = false;
      return;
    }

    if (impact.description !== "report" && impact.file == null) {
      //console.log('‚ùå projectImpact.file is required when description is not "report"');
      isCanGo.value = false;
      return;
    }

    //console.log("‚úÖ projectImpact is valid");

    // ‚úÖ ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô
    //console.log("üéâ All fields in Project_Data_P5 are valid, isCanGo = true");
    isCanGo.value = true;
  },
  { deep: true, immediate: true }
);

const submitForm = async () => {
  loading.value = true
  await submitFile(); 
  await autoSave();
  nextStep();
};

onMounted(async () => {
  const route = useRoute();
  const user = parseJwt(cookies.get("accesstoken"));
  user_id.value = user.user_id;
  affiliation_id.value = user.affiliation_id;

  if (route.query.project_type) {
    const projectType = route.query.project_type;
    project_type.value = projectType;
  }

  if (route.query.project_id) {
    const projectId = route.query.project_id;
    project_id.value = projectId;

    isInitialized = true;
    canEdit = false; // true
    await getDataWhenProjectID();
    canEdit = true;
  } else {
    isInitialized = true;
    canEdit = true; //false
  }
  //console.log("Project id:", project_id.value);
  //console.log("Project Type:", project_type.value);
  //console.log("user_id:", user_id.value);

  if (project_id.value && project_type.value) {
    fetchExistingFile();
  }
});

onUnmounted(() => {
  window.addEventListener("beforeunload", (event) => {
    event.preventDefault();
  });
});

const nextStep = () => {
  if (currentStep.value < 7) {
    currentStep.value++;
  }
};

const prevStep = () => {
  if (currentStep.value > 1) {
    currentStep.value--;
  }
};
</script>

<style lang="css" scoped>
.circle-input {
  border-radius: 50%;
  width: 20px;
  height: 20px;
  background-color: transparent;
  border: 1px solid white;
}

.beautiful-box {
  height: 50px !important;
  border-radius: 6px !important;
}
</style>
